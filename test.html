<!DOCTYPE html>
<html>
  <head>
    <title>Multi-Slot Ad System</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .ad-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
      }
      .ad-slot {
        border: 1px solid #ddd;
        text-align: center;
        padding: 10px;
      }
      .loading, .error {
        width: 100%;
        text-align: center;
        padding: 10px;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Multi-Slot Ad System</h1>
    <div id="adContainer" class="ad-container"></div>

    <script>
    class AdSystem {
      constructor() {
        this.adSlots = [
          { width: 1920, height: 1080 },
          { width: 600, height: 500 },
          { width: 600, height: 500 },
          { width: 1067, height: 600 },
          { width: 1200, height: 800 },
          { width: 1200, height: 800 },
          { width: 300, height: 250 },
          { width: 300, height: 250 },
          { width: 300, height: 50 },
          { width: 300, height: 50 },
          { width: 300, height: 600 },
          { width: 300, height: 600 },
          { width: 320, height: 480 },
          { width: 320, height: 480 },
          { width: 480, height: 320 },
          { width: 480, height: 320 }
        ];
        this.bidderUrl = "https://bidder.verismart.ai/advilion";
        this.container = document.getElementById('adContainer');
      }

      async initialize() {
        for (const slot of this.adSlots) {
          const adSlotElement = this.createAdSlotElement(slot);
          this.container.appendChild(adSlotElement);
          await this.loadAdForSlot(adSlotElement, slot);
        }
      }

      createAdSlotElement(slot) {
        const slotElement = document.createElement('div');
        slotElement.className = 'ad-slot';
        slotElement.setAttribute('data-width', slot.width);
        slotElement.setAttribute('data-height', slot.height);
        slotElement.innerHTML = `Loading ad for ${slot.width}x${slot.height}...`;
        return slotElement;
      }

      async loadAdForSlot(slotElement, slot) {
        try {
          const bidResponse = await this.makeBidRequest(slot);
          this.renderAd(slotElement, bidResponse);
        } catch (error) {
          this.showError(slotElement, "Failed to load advertisement");
          console.error(`Ad System Error for ${slot.width}x${slot.height}:`, error);
        }
      }

      async makeBidRequest(slot) {
        const bidRequest = {
          id: this.generateUUID(),
          imp: [{
            id: "1",
            banner: {
              w: slot.width,
              h: slot.height,
              pos: 0,
            },
            tagid: "477097",
            bidfloor: 5,
            bidfloorcur: "INR",
            secure: 1,
          }],
          site: {
            id: "87",
            name: "NBT Android Apps",
            bundle: "com.nbt.reader",
            domain: "http://navbharattimes.indiatimes.com",
            publisher: { id: "87" },
          },
          device: {
            ua: navigator.userAgent,
            geo: {
              lat: 28.6139,
              lon: 77.209,
              type: 2,
              country: "IND",
              region: "DL",
              city: "Delhi",
            },
            devicetype: 1,
            make: "iPhone",
            model: "Apple",
            os: "iOS",
            osv: "14",
            js: 1,
            carrier: "airtel",
          },
          user: {
            buyeruid: this.generateUUID(),
          },
          at: 1,
          tmax: 480,
          cur: ["INR"],
        };

        const response = await fetch(this.bidderUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(bidRequest),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      }

      generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      renderAd(slotElement, bidResponse) {
        if (!bidResponse?.seatbid?.[0]?.bid?.[0]) {
          this.showError(slotElement, "No valid bid received");
          return;
        }

        const bid = bidResponse.seatbid[0].bid[0];
        const urls = this.extractUrls(bid.adm);

        if (!urls.imageUrl) {
          this.showError(slotElement, "Invalid ad creative received");
          return;
        }

        // Clear slot content
        slotElement.innerHTML = '';

        // Create ad elements
        const anchor = document.createElement('a');
        const img = document.createElement('img');

        // Set attributes
        anchor.href = urls.clickUrl || '#';
        img.src = urls.imageUrl;
        img.width = urls.width;
        img.height = urls.height;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';

        // Add loading and error handlers
        img.onload = () => {
          if (urls.impressionUrl) {
            this.trackViewability(img, urls.impressionUrl);
          }
        };
        img.onerror = () => {
          this.showError(slotElement, "Failed to load advertisement image");
        };

        // Construct DOM
        anchor.appendChild(img);
        slotElement.appendChild(anchor);

        // Handle win notice
        if (bid.nurl) {
          this.sendImpression(this.replaceAuctionMacros(bid.nurl, bid));
        }
      }

      extractUrls(adm) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(adm, 'text/html');
        const anchor = doc.querySelector('a');
        const img = doc.querySelector('img');

        return {
          clickUrl: anchor?.href,
          impressionUrl: img?.getAttribute('onload') 
            ? this.extractImpressionUrl(img.getAttribute('onload')) 
            : null,
          imageUrl: img?.src,
          width: img?.width,
          height: img?.height
        };
      }

      extractImpressionUrl(onloadAttr) {
        const match = onloadAttr.match(/sendUrl\('([^']+)'\)/);
        return match ? match[1] : null;
      }

      showError(slotElement, message) {
        slotElement.innerHTML = `<div class="error">${message}</div>`;
      }

      trackViewability(imageElement, impressionUrl) {
        const observerOptions = { threshold: 0.5 };
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              this.sendImpression(impressionUrl);
              observer.unobserve(imageElement);
            }
          });
        }, observerOptions);

        observer.observe(imageElement);
      }

      sendImpression(url) {
        if (!url) return;

        fetch(url, {
          method: 'GET',
          mode: 'no-cors',
          credentials: 'omit'
        }).catch((error) => {
          console.warn('Impression tracking failed', error);
        });
      }

      replaceAuctionMacros(url, bid) {
        return url
          .replace('${AUCTION_ID}', bid.id || '')
          .replace('${AUCTION_BID_ID}', bid.bidid || '')
          .replace('${AUCTION_IMP_ID}', bid.impid || '')
          .replace('${AUCTION_SEAT_ID}', bid.seat || '')
          .replace('${AUCTION_AD_ID}', bid.adid || '')
          .replace('${AUCTION_PRICE}', bid.price || '')
          .replace('${AUCTION_CURRENCY}', 'INR')
          .replace('${AUCTION_MBR}', '');
      }
    }

    // Initialize the ad system
    document.addEventListener('DOMContentLoaded', () => {
      const adSystem = new AdSystem();
      adSystem.initialize();
    });
    </script>
  </body>
</html>